
### **函数功能定位**
该函数是 VVC 解码端（或编码端重建回路）的 **逆变换核心**，完成：
1. **反量化**：将量化系数还原为变换系数
2. **逆LFNST**（可选）：解除低频不可分变换
3. **逆变换**：将频域系数转换回空域残差
4. **残差重建**：输出可用于帧重建的残差信号

---

### **参数深度解析**
| 参数 | 技术含义 | 关联标准条款 |
|------|----------|--------------|
| `tu` | 当前变换单元 | VVC标准6.4.1节 |
| `compID` | 分量标识（Y:0, Cb:1, Cr:2） | 标准7.3.2.1 |
| `pResi` | 输出残差缓冲区 | 标准8.7.3 |
| `cQP` | 量化参数（含色度QP偏移） | 标准8.6.2 |

---

### **关键处理流程**

#### **1. 初始化与校验**
```cpp
CHECK(uiWidth > tu.cs->sps->getMaxTbSize()...);  // 符合VVC标准表6.1
```
- 强制校验变换尺寸 ≤ 64x64（VVC最大TB尺寸）
- 避免内存越界和计算溢出

#### **2. 反量化处理**
```cpp
xDeQuant(tu, tempCoeff, compID, cQP);
```
- **核心操作**：
  - 按 `cQP` 重建系数幅度
  - 应用量化矩阵（Scaling List）
  - 处理色度QP偏移（Chroma QP Offset）
- **数学本质**：  
  \( coeff' = coeff \times 2^{\lfloor QP/6 \rfloor} \times LevelScale[QP\%6] \)

#### **3. 逆LFNST处理**
```cpp
if (tu.cs->sps->LFNST) xInvLfnst(tu, compID);
```
- **触发条件**：
  - SPS中启用LFNST（`sps_lfnst_enabled_flag=1`）
  - TU的`lfnst_idx>0`
- **技术要点**：
  - 使用16x16矩阵乘法（标准8.7.2.3）
  - 仅处理低频4x4区域（提升高频重建精度）

#### **4. 逆变换选择**
```cpp
if (tu.mtsIdx[compID] == MTS_SKIP) {
    xITransformSkip(...);  // 标准8.7.2.2
} else {
    xIT(...);  // 标准8.7.2.1
}
```
| 模式 | 变换类型 | 适用场景 |
|------|----------|----------|
| `MTS_SKIP` | 直接复制系数 | BDPCM/Transform Skip |
| 常规模式 | DCT-II/DST-VII | 根据`mtsIdx`选择 |

**xIT核心优化**：
- 分离式行列变换（减少中间缓存）
- 基于SIMD的快速蝶形算法
- 针对4/8/16/32点变换的专用优化

#### **5. 残差输出**
```cpp
DTRACE_PEL_BUF(D_RESIDUALS, pResi...);  // 调试验证
```
- 输出残差范围：`[-2^{bitdepth}, 2^{bitdepth}-1]`
- 后续与预测信号相加完成帧重建

---

### **与编码器协同工作**
1. **RDO循环**：
   - 编码器会多次调用本函数计算率失真代价
2. **并行处理**：
   - 不同TB/CB可并行执行逆变换
3. **内存管理**：
   - 重用`m_plTempCoeff`缓冲区减少分配开销

---

### **标准符合性检查**
本函数严格实现VVC标准以下条款：
- 反量化：8.6.2节
- 逆LFNST：8.7.2.3节
- 逆变换：8.7.2.1/8.7.2.2节
- 残差计算：8.7.3节

---

### **性能优化亮点**
1. **分支预测优化**：
   - 提前检查`MTS_SKIP`和`LFNST`标志
2. **内存局部性**：
   - 系数缓冲区按最大TB尺寸预分配
3. **指令级并行**：
   - 使用AVX2指令加速矩阵运算

该函数体现了现代视频编码在变换域重建环节的精妙设计，平衡了重建精度与计算复杂度。