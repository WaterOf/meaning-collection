# ISP与MIP在视频编解码中的技术与应用

ISP（Intra Sub-Partitions，帧内子分区）和MIP（Matrix-based Intra Prediction，基于矩阵的帧内预测）是VVC/H.266标准中引入的两项重要帧内编码技术，它们显著提高了帧内预测的效率。下面我将详细解析这两项技术及其在编解码中的作用。

## ISP（Intra Sub-Partitions，帧内子分区）

### 基本概念
ISP是一种将亮度编码块(CB)垂直或水平分割为2或4个子分区的技术，每个子分区独立进行预测和变换。

### 技术特点
1. **分区方式**：
   - 支持两种分割方向：垂直分割和水平分割
   - 支持两种分区数量：2分区或4分区
   - 分区大小限制：最小4×4，最大64×64

2. **处理流程**：
   ```mermaid
   graph TD
   A[原始CU] --> B{ISP决策}
   B -->|启用| C[分割为子分区]
   B -->|不启用| D[常规帧内编码]
   C --> E[每个子分区独立处理]
   E --> F[预测]
   E --> G[变换/量化]
   E --> H[重建]
   ```

3. **编码优势**：
   - 更精细的预测：每个子分区可以使用不同的预测模式
   - 更准确的残差：独立变换量化减少能量泄漏
   - 特别适合包含复杂纹理或边缘的区域

### 在VVENC中的实现
在您之前看到的代码中，ISP相关处理体现在：
```cpp
cu.ispMode = NOT_INTRA_SUBPARTITIONS; // 初始化ISP模式
m_cIntraSearch.m_ispTestedModes[0].init(0, 0, 1); // 初始化ISP测试模式
```

## MIP（Matrix-based Intra Prediction，基于矩阵的帧内预测）

### 基本概念
MIP是一种使用矩阵向量乘法生成预测信号的帧内预测技术，特别适合捕捉非方向性纹理。

### 技术特点
1. **预测原理**：
   - 使用预训练的矩阵和偏移向量
   - 通过矩阵向量乘法生成预测值
   - 公式：`pred = M × red + b` (M为预测矩阵，red为下采样参考像素，b为偏移向量)

2. **三种模式类型**：
   | 类型 | 块大小范围 | 参考像素数量 | 预测样本数量 |
   |------|------------|-------------|-------------|
   | I    | 4×4到8×8   | 4           | 16-64       |
   | II   | 4×4到8×8   | 8           | 16-64       |
   | III  | 大于8×8    | 8           | 64-4096     |

3. **编码优势**：
   - 更好地预测复杂纹理
   - 减少方向预测模式的数量
   - 特别适合自然图像中的不规则纹理

### 在编解码器中的实现
MIP通常在帧内预测阶段实现：
```cpp
// 伪代码示例
if (使用MIP模式) {
    // 1. 获取参考像素并下采样
    // 2. 选择适当的MIP矩阵和偏移向量
    // 3. 执行矩阵向量乘法
    // 4. 上采样得到最终预测
}
```

## ISP与MIP的协同作用

1. **互补关系**：
   - ISP处理分区内的预测
   - MIP提供更精确的预测方法
   - 两者可以结合使用

2. **在VVENC中的交互**：
   ```cpp
   // 在帧内预测过程中
   if (允许ISP) {
       尝试各种ISP分割方式;
       for (每种ISP分割) {
           使用常规/MIP预测模式;
           计算RD代价;
       }
   }
   ```

3. **性能影响**：
   - ISP提高编码效率约0.5%-1.5%
   - MIP提高编码效率约0.8%-1.2%
   - 组合使用可获得更好的压缩性能

## 实际应用场景

1. **ISP适用场景**：
   - 包含明显边缘或方向性纹理的区域
   - 大尺寸编码单元(CU)
   - 高分辨率视频内容

2. **MIP适用场景**：
   - 复杂非方向性纹理区域
   - 自然图像中的不规则图案
   - 低码率情况下的平滑区域

这两项技术共同构成了VVC标准中帧内编码的重要改进，使新一代编码标准在不显著增加计算复杂度的情况下，获得了更好的压缩效率。