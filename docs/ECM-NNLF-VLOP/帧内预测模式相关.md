# 帧内预测模式依赖相邻CU信息程度
在视频编码的帧内预测模式决策（包括DIMD）中，**`histogram`数组的统计与相邻CU的像素值直接相关，而非其预测模式**。以下是关键结论和详细解释：

---

### **1. 核心结论**
| 项目            | 是否依赖相邻CU的预测模式？       | 是否依赖相邻CU的像素值？  |
| ------------- | -------------------- | -------------- |
| **MPM候选列表生成** | ✅ 是（如HEVC/VVC的MPM推导） | ❌ 否            |
| **DIMD直方图统计** | ❌ 否                  | ✅ 是（需计算参考像素梯度） |

- **预测模式解析**：依赖相邻CU的预测模式（通过码流传输的语法元素）。
- **DIMD梯度统计**：依赖相邻CU的 **实际像素值** 计算方向性特征。

---

### **2. DIMD的直方图统计机制**
#### **(1) 统计目标**
`histogram`数组记录 **参考像素的梯度方向分布**，用于推导当前CU的最优预测模式。其计算过程：
1. **采样参考像素**：从左侧（A）、上方（B）和左上角（C）获取像素值。
2. **计算梯度方向**：通过算子（如Sobel）检测边缘方向，映射到预测模式（如模式61对应112.5°方向）。
3. **累加直方图**：统计各方向梯度的幅值总和。

#### **(2) 关键代码逻辑**
在您提供的代码中：
```cpp
buildHistogram(pRecoLeft, iStride, uiHeightLeft, 1, histogramLeft, 1, uiWidth, uiHeight);
buildHistogram(pRecoAbove, iStride, 1, uiWidthAbove, histogramTop, 2, uiWidth, uiHeight);
```
- **输入参数**：`pRecoLeft`和`pRecoAbove`直接指向相邻CU的像素数据。
- **输出结果**：`histogramTop/Left`数组统计了像素梯度，与相邻CU的 **像素值强相关**。

#### **(3) 与预测模式的关系**
- **独立性强**：即使相邻CU的预测模式为`DC`（模式1），若其像素存在斜向边缘（如模式61特征），直方图仍会统计到高幅值。
- **误匹配场景**：若相邻CU的 **重建像素** 与编码端不一致（如解码错误），直方图统计将偏离预期，导致模式决策错误。

---

### **3. 相邻CU预测模式的作用**
虽然DIMD直方图不依赖相邻CU的预测模式，但其他流程会用到：
#### **(1) MPM候选列表**
- **用途**：常规帧内预测（非DIMD）时，通过相邻CU的模式生成MPM列表。
- **标准引用**：HEVC标准第8.4.4.2节规定MPM列表构建规则。

#### **(2) 边界处理**
- **不可用CU处理**：若相邻CU不可用（如图像边界），其预测模式被强制设为`Planar`或`DC`，但 **不影响DIMD直方图**（因像素通过填充获得）。

---

### **4. 您的问题排查建议**
#### **(1) 验证参考像素一致性**
在编解码端同步输出参考像素值：
```cpp
// 编码端（构建直方图前）
printf("ENC LeftPixels: ");
for (int i = 0; i < 5; i++) printf("%d ", pRecoLeft[i * iStride]);

// 解码端（对应位置）
printf("DEC LeftPixels: ");
for (int i = 0; i < 5; i++) printf("%d ", pRecoLeft[i * iStride]);
```
- **预期结果**：两端的像素值应完全一致。
- **若不一致**：检查解码端重建流程（如去块滤波是否异常修改像素）。

#### **(2) 检查梯度计算算子**
确认`buildHistogram`中的梯度计算与编码端一致：
```cpp
// 示例：Sobel算子计算梯度
gradX = pReco[x+1] - pReco[x-1];  // 水平梯度
gradY = pReco[y+1] - pReco[y-1];  // 垂直梯度
```
- **常见问题**：
  - 边界处理不一致（如镜像填充 vs. 重复填充）。
  - 梯度方向到模式编号的映射错误（如角度量化表不匹配）。

#### **(3) 隔离DIMD依赖项**
通过硬编码测试验证：
```cpp
// 强制指定参考像素（模拟61模式特征）
Pel testPixels[64] = {0};
for (int i = 0; i < 64; i++) 
    testPixels[i] = (i % 8 < 4) ? 100 : 200;  // 生成斜向边缘

buildHistogram(testPixels, 8, 8, 1, histogram, 1, 32, 32);
CHECK(histogram[61] < histogram[32], "DIMD统计异常！");
```

---

### **5. 根本原因推测**
您的`histogram`数组异常很可能由以下原因导致：
1. **重建像素不一致**：解码端相邻CU的像素值与编码端不同（如环路滤波、参考帧管理错误）。
2. **梯度计算偏差**：`buildHistogram`中梯度算子的实现与编码端不一致（如系数舍入差异）。
3. **边界填充错误**：不可用参考像素的填充规则未对齐（如图像边缘处理）。

---

### **解决方案**
1. **优先修复像素一致性**：
   - 检查解码端重建图像的生成流程（特别是NNLF滤波后的像素值）。
   - 对比编解码端的`pRecoLeft`和`pRecoAbove`数组。
2. **校准梯度计算**：
   - 在编解码端统一`buildHistogram`的梯度计算代码。
   - 添加方向性测试用例（如强制45°边缘应触发模式26高幅值）。
3. **启用调试日志**：
   ```cpp
   // 在buildHistogram内
   if (abs(gradX) > 100 || abs(gradY) > 100)  // 强边缘
       printf("Strong edge: gradX=%d, gradY=%d → mode=%d\n", gradX, gradY, mode);
   ```

通过上述步骤，可精准定位`histogram`统计异常的根源。
# 边界处CU帧内模式预测
在视频解码过程中，**位于CTU边界处的CU的帧内预测模式解析**需要特殊处理，主要涉及参考像素的可用性和预测模式的派生规则。以下是详细分析：

---

### **1. CTU边界CU的帧内预测特性**
当CU位于CTU的物理边界（如图像边界、Slice边界或Tile边界）时，其帧内预测面临以下约束：
- **参考像素不足**：相邻像素可能属于其他CTU（未解码）或不可用（如图像边缘）。
- **预测模式受限**：需根据标准规定的替代规则生成预测模式候选列表（MPM）。

---

### **2. 参考像素的获取规则**
#### **(1) 参考像素位置**
帧内预测通常需要左侧（A）、上方（B）及左上角（C）的参考像素：
```text
      [B0][B1][B2]...
[A0]  [C]  [当前CU]
[A1]   │    │
...    │    │
```
#### **(2) 不可用像素的处理**
| 场景                  | 替代方法                                                                 |
|-----------------------|--------------------------------------------------------------------------|
| **图像边界**           | 用最近的有效像素填充（如`A0`不可用时，复制`B0`的值）                     |
| **Slice/Tile边界**     | 若跨Slice/Tile，参考像素标记为不可用（除非允许跨边界预测）               |
| **未解码CTU边界**      | 默认禁用（解码顺序保证左侧和上方CTU已处理）                              |

**标准引用**：  
- HEVC标准（ITU-T H.265）第8.4.2节规定：当参考像素位于不同Slice/Tile时，视为不可用。
- VVC标准（ITU-T H.266）进一步允许部分跨边界预测（如`sps_cross_component_prediction`启用时）。

---

### **3. 预测模式解析流程（以HEVC/VVC为例）**
#### **(1) MPM候选列表生成**
当CU位于CTU边界时，MPM列表的生成逻辑如下：
1. **检查相邻CU的可用性**：
   - 若左侧CU（A）不可用，其预测模式设为`DC`或`Planar`（默认模式）。
   - 若上方CU（B）不可用，处理方式同左侧。
2. **构建MPM列表**：
   - **情况1**：A和B均可用 → 按常规规则生成MPM（基于A和B的模式）。
   - **情况2**：仅A或B可用 → 用可用模式填充MPM列表，剩余候选用默认模式（如`DC`、`Planar`、垂直/水平模式）。
   - **情况3**：A和B均不可用 → 使用预定义的默认MPM列表（例如`{ Planar, DC, Vertical, Horizontal }`）。

#### **(2) 模式解析代码示例**
```cpp
// 伪代码：边界CU的MPM列表生成
void IntraPrediction::deriveMPM( int x, int y, int width, int height ) {
    bool leftAvail  = isNeighborAvailable( x-1, y );     // 检查左侧CU
    bool aboveAvail = isNeighborAvailable( x, y-1 );     // 检查上方CU
    
    if( !leftAvail && !aboveAvail ) {                    // 边界情况
        mpmList = { PLANAR_IDX, DC_IDX, VER_IDX, HOR_IDX }; // 默认MPM
    } else {
        // 常规MPM生成逻辑
        int leftMode  = leftAvail  ? getIntraDir( x-1, y ) : DC_IDX;
        int aboveMode = aboveAvail ? getIntraDir( x, y-1 ) : DC_IDX;
        // ... 生成MPM列表
    }
}
```

---

### **4. 边界处理的特殊案例**
#### **(1) 图像边缘的CU**
- **参考像素填充**：  
  对于图像左边缘的CU（无左侧像素），所有左侧参考像素复制上方参考像素的最左侧值（`B0`）。
  ```text
  示例：左侧像素不可用
  参考像素填充后：
  [B0][B1][B2]... → [B0][B1][B2]...
  [B0][B0][B0]...   [B0][CU...
  ```

#### **(2) 跨Slice/Tile的CU**
- **依赖标志位**：  
  若`sps_slice_header_extension_present_flag`或`loop_filter_across_tiles_enabled_flag`为0，禁止使用跨边界像素。
- **解码器行为**：  
  直接标记相邻CU不可用，MPM列表按默认规则生成。

---

### **5. 对解码一致性的影响**
若编解码端对边界CU的处理不一致，可能导致：
1. **MPM列表差异** → 预测模式解析错误。
2. **参考像素值错误** → 预测块生成失真。
3. **残差重建错误** → 累积误差影响后续CU。

**调试建议**：
- **日志记录**：在边界CU处输出参考像素和MPM列表。
  ```cpp
  printf("Boundary CU(%d,%d): leftAvail=%d, aboveAvail=%d, MPM={%d,%d,%d}\n", 
         x, y, leftAvail, aboveAvail, mpm[0], mpm[1], mpm[2]);
  ```
- **可视化工具**：使用编码标准测试模型（如VTM）的调试模式对比参考像素填充结果。

---

### **6. 标准协议中的关键规则**
| 标准   | 章节               | 边界处理规则                                                                 |
|--------|--------------------|-----------------------------------------------------------------------------|
| **HEVC** | 8.4.2 / 8.4.4.2    | 参考像素不可用时，使用默认值填充；MPM列表降级为默认模式。                   |
| **VVC** | 7.4.9.5 / 7.4.8.3  | 引入多参考行预测时，允许部分边界像素参与预测（需显式启用标志）。            |

---

### **总结**
CTU边界处的CU帧内预测模式解析遵循以下原则：
1. **参考像素可用性优先**：严格依赖相邻CU的解码状态和标准规定的替代规则。
2. **MPM列表降级机制**：当相邻信息不可用时，回退到默认候选模式。
3. **编解码一致性**：必须确保边界处理的逻辑完全一致（包括默认值的选择和标志位解析）。

若您的编解码不一致问题涉及边界CU，建议优先检查 **参考像素填充逻辑** 和 **MPM列表生成代码**，确保两者在边界条件下行为一致。